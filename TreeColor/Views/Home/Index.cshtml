@model List<TreeColor.Models.Tests>
@{
    ViewBag.Title = "Home Page";
    ViewBag.TestName = "Example";
}
<div class="row">
    <div class="col s2">
        <button class="waves-effect waves-light btn" onclick="StartTesting()" id="StartTesting">Start testing</button>
    </div>
    <p class="counter right">0/30</p>
</div>
<div class="row" style="height : 75%;">
    @if (ViewBag.CurrentTest != null)
    {
        <div class="col s1 light-blue" style="min-height: 100%;">
            @foreach (TreeColor.Models.Points point in ViewBag.CurrentTest.Points)
            {
            <h5 color=@point.color>@point.Symbol</h5>
            }
        </div>
        <div class="col s11 divv" color="#@Convert.ToString(ViewBag.CurrentTest.field_color, 16)" style="min-height: 100%;">
            <canvas id="canvas" onclick="press()" width="1200" height="475"></canvas>
        </div>
        <script>
            var count = 0;
            var i = 0;
            var allIsGood = false;
            var canvas = document.getElementById('canvas');
            canvas.width = document.getElementByClass("divv").width;
            canvas.height = document.getElementByClass("divv").height;
            var context = canvas.getContext('2d');
            var currX = Math.random() * canvas.width + 50;
            var currY = Math.random() * canvas.height + 50;

            function Drawing()
            {
                var fps = 50;
                var timer = setInterval(function () {
                    if(allIsGood)
                    {
                        context.beginPath();
                        context.arc(currX, currY, i++, 0, 2 * Math.PI, false);
                        context.fillStyle = '#FFFFFF';
                        context.fill();
                        context.stroke();
                    }
                    else
                    {
                        clearInterval(timer)
                    }
                }, 1000 / fps)
            }
            function press() {  
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                var Result = {
                    'testingnumbe': @ViewBag.CurrentTest.id,
                    'pointid' : 1,
                    'tim': 20,
                    };

                i = 0;
                $.ajax({
                    type: "POST",
                    url: "/Home/PutResult",
                    data: JSON.stringify(Result),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: successFunc,
                    error: errorFunc
                });
               
                currX = Math.random() * 500 + 100;
                currY = Math.random() * 150 + 50;
            }
            function successFunc(data, status) {
                if(data == true)
                {
                    $(".counter").text(count++ + "/30");
                } 
                else
                {
                    StartTesting()
                    alert(data);
                }
            }

            function errorFunc(errorData) {
                alert('Ошибка' + errorData.responseText);
                StartTesting()
            }

            function StartTesting()
            {
                if(!allIsGood)
                {
                    allIsGood = true;
                    $("#StartTesting").text("Stop testing");
                    Drawing();
                } 
                else
                {
                    allIsGood = false;
                    $(".counter").text("0/30");
                    $("#StartTesting").text("Start testing");
                }
            }
        </script>
    }
    else
    {
        <p>Select the test!</p>
    }
</div>
